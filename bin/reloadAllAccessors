#!/bin/sh
# $Id$
# Reload all the accessors in the models that have JSAccessors actors
# See https://accessors.org/wiki/Main/CapeCodeHost#ReloadAllAccessors

commit=false
if [ $# -ge 1 ]; then
    if [ $1 = "-commit" ]; then
        echo "$0: Will commit any changed models."
        commit="true";
    fi
fi    

modelsFile=/tmp/reloadAllAccessors.models.$$

echo "$0: This script reloads all the JSAccessors in all the .xml files that are part of the ptII tree."
echo "To reload just a few files, try:"
echo "  $PTII/bin/ptinvoke ptolemy.vergil.basic.imprt.accessor.ReloadAccessors model1.xml model2.xml"

if [ "$commit" = "true" ]; then
    echo "Updating the accessors and ptII repos."
    (cd $PTII/org/terraswarm/accessor/accessors/web; svn update)
    (cd $PTII; svn update)
fi

echo ""
echo "$0: Generating the list of .xml files"
cd $PTII
$PTII/adm/bin/ptIItxtfiles | egrep '.xml$' | grep -v ' ' | grep -v 'findbugsOut.xml' | grep -v ptolemy/apps | grep -v bin/reloadAllAccessors | grep -v vendors > $modelsFile

echo "$0: Generating the list of .xml files that contain JSAccessor.  This will take a moment."

jsaccessors=/tmp/reloadAllAccessors.jsaccessors.$$
cat $modelsFile | xargs grep 'org.terraswarm.accessor.JSAccessor' | awk -F : '{print $1}' | sort | uniq > $jsaccessors

echo "$0: Reloading Accessors in `wc -l $jsaccessors | awk '{print $1}'` models."
cat $jsaccessors | xargs $PTII/bin/ptinvoke ptolemy.vergil.basic.imprt.accessor.ReloadAccessors

if [ "$commit" = "true" ]; then
    # Commit only models that are marked with M in svn status so that we avoid
    # attempting to commit models that have not been checked in.
    jsaccessorsNoVendors=`cat $jsaccessors | grep -v /vendors/`
    jsaccessorsToBeCommitted=`svn status $jsaccessorsNoVendors | egrep "^M" | awk '{print $2}'`

    echo "$0: Commit to the accessor repo"
    svn commit -m "Reloaded accessors using $PTII/bin/reloadAllAccessors." `echo $jsaccessorsToBeCommitted | grep org/terraswarm/accessor/accessors/web`

    echo "$0: Commit to the ptII repo."
    svn commit -m "Reloaded accessors using $PTII/bin/reloadAllAccessors." `echo $jsaccessorsToBeCommitted | grep -v org/terraswarm/accessor/accessors/web`
fi    

rm -f $modelsFiles $jsaccessors
