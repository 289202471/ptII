#!/bin/sh
# $Id$

# bin/npm - a wrapper script for Node.js that runs a version
# of npm in $PTII/vendors/node if it is present.

if [ -z "$PTII" ]; then
    echo "$0: \$PTII must be set."
    exit 3
fi

if [ ! -e "$PTII" ]; then
    echo "$0: \$PTII is $PTII, which does not exist?"
    exit 4
fi

NODE_VERSION=$PTII/vendors/node/node-v8.4.0
OS=`uname -s`
MACHINE=`uname -m`
case $OS in
    Cygwin*)
        if [ "$MACHINE" = "x86_64" ]; then
            NODE_DIR=${NODE_VERSION}-win-x64
        else
            NODE_DIR=${NODE_VERSION}-win-32
        fi
        ;;
    Darwin)
        NODE_DIR=${NODE_VERSION}-darwin-x64;;
    Linux)
        if [ "$MACHINE" = "x86_64" ]; then
            NODE_DIR=${NODE_VERSION}-linux-x64
        else
            NODE_DIR=${NODE_VERSION}-linux-32
        fi
        ;;
    *) NODE_DIR=${NODE_VERSION}-unknownArch;;
esac

NPM="$NODE_DIR/bin/npm"
if [ -f "$NPM" ]; then
    if [ ! -x "$NPM" ]; then
        chmod a+x "$NPM"
    fi
    echo "$0: Running ptII-specific npm: $NPM $@"
    exec "$NPM" $@
    retval=$?
    exit $?
else
    (
        IFS=:
        for p in $PATH; do
            # Find the first npm that is not $PTII/bin/npm
            #echo "Looping through path: $p/npm"
            if [ -x "$p/npm" ]; then
                #echo "$0: $p/npm is executable: $0"
                # Ideally, we would use -ef here, but it is an extension
                if [ "$p/npm" != "$0" ]; then
                    #echo "$0: $p/npm is not the same as $0"
                    echo "$0: Running $p/npm $@"
                    exec "$p/npm" $@
                    retval=$?
                    exit $?
                fi
            fi
        done
        echo "$0: Could not find npm in $PATH, perhaps npm is not installed?  See https://nodejs.org/en/download/"
        exit 2
    )
fi
